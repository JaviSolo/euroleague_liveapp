<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Euroliga LiveScore</title>
    <style>
        /* Basic styles for a clean display */
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }
        h1 { text-align: center; }
        .match { background-color: #fff; padding: 15px; margin: 10px auto; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); max-width: 500px; }
        .match h2 { margin: 0 0 10px; }
        .match p { margin: 5px 0; }
        .details { background-color: #e8e8e8; padding: 10px; margin-top: 10px; border-radius: 3px; }
        /* Table width set to auto with a maximum of 33% of the container and centered */
        table { width: auto; max-width: 33%; margin: auto; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: center; border: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .total-cell { font-weight: bold; background-color: #ffeb3b; } /* Highlight total column */
        button { padding: 5px 10px; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Euroliga LiveScore</h1>
    <div id="matches"></div>
    <!-- Section to display match details -->
    <div id="match-details"></div>

    <script>
        // Global variable to hold the interval for updating match details
        let detailsInterval = null;

        // Function to fetch live matches data from the API
        function fetchLiveMatches() {
            fetch("http://127.0.0.1:5000/api/live_matches")
            .then(response => response.json())
            .then(data => {
                const matchesDiv = document.getElementById("matches");
                matchesDiv.innerHTML = ""; // Clear previous content
                data.forEach(match => {
                    const matchDiv = document.createElement("div");
                    matchDiv.classList.add("match");
                    matchDiv.innerHTML = `
                        <h2>${match.team1} vs ${match.team2}</h2>
                        <p>Score: ${match.score}</p>
                        <p>Quarter: ${match.quarter} - Minute: ${match.minute}</p>
                        <!-- Button calls fetchMatchDetails passing URL and team names -->
                        <button onclick="fetchMatchDetails('${encodeURIComponent(match.url)}', '${match.team1}', '${match.team2}')">View Details</button>
                    `;
                    matchesDiv.appendChild(matchDiv);
                });
            })
            .catch(error => console.error("Error fetching live matches:", error));
        }

        // Function to fetch detailed match data and update details in real time
        // Accepts homeName and awayName as additional parameters
        function fetchMatchDetails(matchUrl, homeName, awayName) {
            // Clear any existing interval for match details
            if (detailsInterval) {
                clearInterval(detailsInterval);
                detailsInterval = null;
            }
            
            // Define a function to update the details view
            function updateDetails() {
                fetch(`http://127.0.0.1:5000/api/match_details?url=${matchUrl}`)
                .then(response => response.json())
                .then(data => {
                    const detailsDiv = document.getElementById("match-details");
                    
                    // Prepare quarter scores arrays ensuring 5 columns (pad with empty string if missing)
                    let homeScores = data.home_quarter_scores || [];
                    let awayScores = data.away_quarter_scores || [];
                    while (homeScores.length < 5) homeScores.push("");
                    while (awayScores.length < 5) awayScores.push("");
                    
                    // Build an HTML table for match points
                    let tableHTML = `
                        <h2>Match Points</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th>Q1</th>
                                    <th>Q2</th>
                                    <th>Q3</th>
                                    <th>Q4</th>
                                    <th>OT</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${homeName}</td>
                                    <td>${homeScores[0]}</td>
                                    <td>${homeScores[1]}</td>
                                    <td>${homeScores[2]}</td>
                                    <td>${homeScores[3]}</td>
                                    <td>${homeScores[4]}</td>
                                    <td class="total-cell">${data.home_total || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>${awayName}</td>
                                    <td>${awayScores[0]}</td>
                                    <td>${awayScores[1]}</td>
                                    <td>${awayScores[2]}</td>
                                    <td>${awayScores[3]}</td>
                                    <td>${awayScores[4]}</td>
                                    <td class="total-cell">${data.away_total || 'N/A'}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    
                    // Build a section for Top 3 Player Statistics if available
                    let topPlayersHTML = "";
                    if(data.top_player_stats && Array.isArray(data.top_player_stats) && data.top_player_stats.length > 0) {
                        topPlayersHTML = `
                            <h2>Top 3 Player Statistics</h2>
                            <ul>
                                ${data.top_player_stats.map(stat => `<li>${stat}</li>`).join('')}
                            </ul>
                        `;
                    }
                    
                    // Combine the table and the top players section
                    detailsDiv.innerHTML = tableHTML + topPlayersHTML;
                })
                .catch(error => {
                    console.error("Error fetching match details:", error);
                    document.getElementById("match-details").innerHTML = "<p>Error obtaining match details.</p>";
                });
            }
            
            // Update details immediately and then set an interval to update every 10 seconds
            updateDetails();
            detailsInterval = setInterval(updateDetails, 10000);
        }

        // Fetch live matches every 10 seconds and immediately on page load
        setInterval(fetchLiveMatches, 10000);
        fetchLiveMatches();
    </script>
</body>
</html>
